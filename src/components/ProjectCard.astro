---
import { type CollectionEntry } from "astro:content";
import FormattedDate from "@/components/FormattedDate.astro";
import type { ImageMetadata } from "astro";
import { Image } from "astro:assets";

type Props = {
	project: CollectionEntry<'projects'> | undefined
}

const { project } = Astro.props as Props;

const projectImages = import.meta.glob<{ default: ImageMetadata }>(
  "/src/assets/projects/**/*.{jpeg,jpg,png,gif}"
);

const coverImagePath = `/src/assets/projects/${project?.id}-cover.png`;

// Create URL-friendly slugs for category and tags
const categorySlug =
  project?.data.category?.toLowerCase().replace(/\s+/g, "-") || "uncategorized";
const firstTag = project?.data.tags?.[0];
const firstTagSlug = firstTag?.toLowerCase().replace(/\s+/g, "-");
---

<article class="h-full group">
  <div
    class="bg-(--color-surface) dark:bg-(--color-surface-dark) border-4 border-(--color-border) dark:border-(--color-border-dark) rounded-4xl p-4"
  >
    <div class="flex flex-col gap-2 flex-1">
      <div
        class="h-32 mb-2 border-b-4 border-b-(--color-accent) dark:border-b-(--color-accent-dark) relative -left-4 flex justify-start"
        style="width: calc(100% + var(--spacing) * 8)"
      >
        <!-- Category -->
        {
          project?.data.category && (
            <div class="flex items-start gap-2">
              <a
                class="text-xs text-accent dark:text-accent-dark pl-4 z-10"
                href={`/projects/category/${project?.data.category?.toLowerCase().replace(/\s+/g, "-") || "uncategorized"}`}
              >
                <span class="px-3 py-1 text-xs rounded-full bg-primary/80 dark:bg-primary-dark/80 text-crust dark:text-crust-dark border border-primary/90 dark:border-primary-dark/90">
                  {project?.data.category}
                </span>
              </a>
            </div>
          )
        }

        <a
          href={`/projects/${project?.id}/`}
          class="flex flex-col gap-3 h-full"
          aria-label={`Read article: ${project?.data.title}`}
        >
        {
          projectImages[coverImagePath] && <Image
            src={projectImages[coverImagePath]()}
            alt={`Cover image for ${project?.data.title}`}
            class="z-9 absolute -inset-[4px] object-cover mask-clip-border border-4 border-white/0 rounded-t-4xl"
            style="height: calc(100% + 4 * var(--spacing) + 8px); width: calc(100% + 8px); top: calc(-4 * var(--spacing) - px); max-width: 200% !important"
          />
        }
        </a>
      </div>
    </div>

    <a
      href={`/projects/${project?.id}/`}
      class="flex flex-col gap-3 h-full"
      aria-label={`Read article: ${project?.data.title}`}
    >
      <h3
        class="text-xl font-semibold group-hover:text-primary dark:group-hover:text-primary-dark transition-colors duration-150 line-clamp-2"
      >
        {project?.data.title}
      </h3>
      <p
        class="line-clamp-2 text-subtext-1 dark:text-subtext-1-dark leading-relaxed text-sm"
      >
        {project?.data.description}
      </p>
    </a>

    <!-- Tags (show first 4) -->
    {
      project?.data.tags && project?.data.tags.length > 0 && (
        <div class="flex items-center gap-2 flex-wrap">
          {project?.data.tags.slice(0, 4).map((tag: string) => (
            <a
              class="text-xs text-accent dark:text-accent-dark"
              href={`/projects/tag/${tag}`}
            >
              #{tag}
            </a>
          ))}
          {project?.data.tags.length > 4 && (
            <span class="text-xs text-secondary dark:text-secondary-dark">
              +{project?.data.tags.length - 4}
            </span>
          )}
        </div>
      )
    }

    <div
      class="flex items-center gap-3 mt-auto text-xs text-subtext-1 dark:text-subtext-1-dark"
    >
      <time datetime={project?.data.releaseDate.toISOString()}>
        <FormattedDate date={project?.data.releaseDate} />
      </time>
    </div>
  </div>
</article>
