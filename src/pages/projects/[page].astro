---
import { getCollection, type CollectionEntry } from 'astro:content'
import ProjectCard from '@/components/ProjectCard.astro'
import Pagination from '@/components/Pagination.astro'
import BaseLayout from '@/layouts/Layout.astro'
import type { GetStaticPaths, Page } from 'astro'

export const prerender = true;
export const getStaticPaths: GetStaticPaths = async () => {
	const allProjects: CollectionEntry<"projects">[] = await getCollection('projects', ({ data }) => {
		return data.draft !== true
	})

	const sortedProjects = allProjects.sort(
		(a, b) => b.data.releaseDate.valueOf() - a.data.releaseDate.valueOf()
	)

	const pageSize = 9
	const totalPages = Math.ceil(sortedProjects.length / pageSize)

	return Array.from({ length: totalPages - 1 }, (_, i) => i + 2).map(pageNum => {
		const start = (pageNum - 1) * pageSize
		const end = start + pageSize

		return {
			params: { page: String(pageNum) },
			props: {
				page: {
					data: sortedProjects.slice(start, end),
					start,
					end: Math.min(end - 1, sortedProjects.length - 1),
					size: pageSize,
					total: sortedProjects.length,
					currentPage: pageNum,
					lastPage: totalPages,
					url: {
						current: `/blog/${pageNum}`,
						prev: pageNum === 2 ? '/blog' : `/blog/${pageNum - 1}`,
						next: pageNum < totalPages ? `/blog/${pageNum + 1}` : undefined,
					}
				}
			}
		}
	})
}

type Props = {
	page: Page<CollectionEntry<'projects'>>
}

const { page } = Astro.props as Props
const currentPage = page.currentPage || 1
const totalPages = page.lastPage || 1
---

<BaseLayout 
	title={`Projects${currentPage > 1 ? ` - Page ${currentPage}` : ''}`} 
	description="Here you can see all projects I have done."
	prevUrl={page.url.prev}
	nextUrl={page.url.next}
>
	<main class="app-container pt-32 pb-16">
		<div class="space-y-4">
			<h1 class="text-4xl md:text-5xl lg:text-6xl font-bold tracking-tight">
				Projects
			</h1>
			<p class="md:w-2/3 text-lg leading-relaxed text-secondary dark:text-secondary-dark">
				Here you can see all projects I have done.
			</p>
		</div>
	</main>

	<section class="app-container pb-20" aria-label="Blog posts">
		<ul class="posts-grid-container" role="list">
			{
				page.data.map((project) => (
					<li>
						<ProjectCard project={project} />
					</li>
				))
			}
		</ul>

		<!-- Pagination Controls -->
		<Pagination
			currentPage={currentPage}
			totalPages={totalPages}
			prevUrl={page.url.prev}
			nextUrl={page.url.next}
		/>
	</section>
</BaseLayout>
